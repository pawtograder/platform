name: Deploy Branch Preview
on:
  push:
    branches:
      - main
      - staging
  pull_request:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: pawtograder-ci
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Deploy a branch preview environment
        id: deploy
        uses: pawtograder/coolify-supabase-deployment-action@main
        with:
          ephemeral: false
          coolify_api_url: https://coolify.in.ripley.cloud/api/v1
          coolify_server_uuid: ${{ secrets.COOLIFY_SERVER_UUID }}
          coolify_api_token: ${{ secrets.COOLIFY_API_TOKEN }}
          coolify_project_uuid: ${{ secrets.COOLIFY_PROJECT_UUID }}
          coolify_environment_name: ${{ vars.COOLIFY_ENVIRONMENT_NAME }}
          coolify_environment_uuid: ${{ secrets.COOLIFY_ENVIRONMENT_UUID }}
          coolify_supabase_api_url: ${{ secrets.COOLIFY_SUPABASE_API_URL }}
          deployment_app_uuid: ${{ secrets.COOLIFY_DEPLOYMENT_APP_UUID }}
          bugsink_dsn: ${{ secrets.BUGSINK_DSN }}
        env:
          GITHUB_APP_ID: ${{ secrets.PAWTOGRADER_GITHUB_APP_ID }}
          GITHUB_OAUTH_CLIENT_ID: ${{ secrets.PAWTOGRADER_GITHUB_OAUTH_CLIENT_ID }}
          GITHUB_OAUTH_CLIENT_SECRET: ${{ secrets.PAWTOGRADER_GITHUB_OAUTH_CLIENT_SECRET }}
          GITHUB_PRIVATE_KEY_STRING: ${{ secrets.PAWTOGRADER_GITHUB_PRIVATE_KEY_STRING }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Wait for deployment to be accessible
        run: |
          echo "Checking if ${BASE_URL} is accessible..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl --fail --silent --show-error --max-time 10 "${BASE_URL}" > /dev/null 2>&1; then
              echo "✅ Deployment is accessible at ${BASE_URL}"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "⏳ Attempt $ATTEMPT/$MAX_ATTEMPTS - Deployment not yet accessible, waiting 10 seconds..."
            sleep 10
          done
          
          echo "❌ Deployment at ${BASE_URL} is not accessible after $MAX_ATTEMPTS attempts"
          exit 1
        env:
          BASE_URL: ${{ steps.deploy.outputs.app_url }}
      - name: Run Playwright tests
        env:
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          SUPABASE_URL: ${{ steps.deploy.outputs.supabase_url }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ steps.deploy.outputs.supabase_service_role_key }}
          SUPABASE_ANON_KEY: ${{ steps.deploy.outputs.supabase_anon_key }}
          BASE_URL: ${{ steps.deploy.outputs.app_url }}

          ARGOS_TOKEN: ${{ secrets.ARGOS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
