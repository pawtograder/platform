create type "public"."review_round" as enum ('self-review', 'grading-review', 'meta-grading-review');

create table "public"."grading_conflicts" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "grader_profile_id" uuid not null,
    "student_profile_id" uuid not null,
    "class_id" bigint not null,
    "reason" text,
    "created_by_profile_id" uuid not null
);


alter table "public"."grading_conflicts" enable row level security;

create table "public"."review_assignment_rubric_parts" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "review_assignment_id" bigint not null,
    "rubric_part_id" bigint not null,
    "class_id" bigint not null
);


alter table "public"."review_assignment_rubric_parts" enable row level security;

create table "public"."review_assignments" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "due_date" timestamp with time zone not null,
    "assignee_profile_id" uuid not null,
    "submission_id" bigint not null,
    "assignment_id" bigint not null,
    "rubric_id" bigint not null,
    "class_id" bigint not null
);


alter table "public"."review_assignments" enable row level security;

create table "public"."rubric_check_references" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "referencing_rubric_check_id" bigint not null,
    "referenced_rubric_check_id" bigint not null,
    "class_id" bigint not null
);


alter table "public"."rubric_check_references" enable row level security;

alter table "public"."rubrics" add column "review_round" review_round default 'grading-review'::review_round;

alter table "public"."submission_artifact_comments" add column "eventually_visible" boolean not null default true;

alter table "public"."submission_comments" add column "eventually_visible" boolean not null default true;

alter table "public"."submission_file_comments" add column "eventually_visible" boolean not null default true;

CREATE UNIQUE INDEX grading_conflicts_pkey ON public.grading_conflicts USING btree (id);

CREATE UNIQUE INDEX review_assignment_rubric_parts_pkey ON public.review_assignment_rubric_parts USING btree (id);

CREATE UNIQUE INDEX review_assignments_pkey ON public.review_assignments USING btree (id);

CREATE UNIQUE INDEX rubric_check_references_pkey ON public.rubric_check_references USING btree (id);

CREATE UNIQUE INDEX unique_grading_conflict_key ON public.grading_conflicts USING btree (grader_profile_id, student_profile_id, class_id);

CREATE UNIQUE INDEX unique_review_assignment_rubric_part ON public.review_assignment_rubric_parts USING btree (review_assignment_id, rubric_part_id);

CREATE UNIQUE INDEX unique_rubric_check_reference_per_class ON public.rubric_check_references USING btree (referencing_rubric_check_id, referenced_rubric_check_id, class_id);

alter table "public"."grading_conflicts" add constraint "grading_conflicts_pkey" PRIMARY KEY using index "grading_conflicts_pkey";

alter table "public"."review_assignment_rubric_parts" add constraint "review_assignment_rubric_parts_pkey" PRIMARY KEY using index "review_assignment_rubric_parts_pkey";

alter table "public"."review_assignments" add constraint "review_assignments_pkey" PRIMARY KEY using index "review_assignments_pkey";

alter table "public"."rubric_check_references" add constraint "rubric_check_references_pkey" PRIMARY KEY using index "rubric_check_references_pkey";

alter table "public"."grading_conflicts" add constraint "grading_conflicts_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."grading_conflicts" validate constraint "grading_conflicts_class_id_fkey";

alter table "public"."grading_conflicts" add constraint "grading_conflicts_created_by_profile_id_fkey" FOREIGN KEY (created_by_profile_id) REFERENCES profiles(id) ON UPDATE CASCADE ON DELETE RESTRICT not valid;

alter table "public"."grading_conflicts" validate constraint "grading_conflicts_created_by_profile_id_fkey";

alter table "public"."grading_conflicts" add constraint "grading_conflicts_grader_profile_id_fkey" FOREIGN KEY (grader_profile_id) REFERENCES profiles(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."grading_conflicts" validate constraint "grading_conflicts_grader_profile_id_fkey";

alter table "public"."grading_conflicts" add constraint "grading_conflicts_student_profile_id_fkey" FOREIGN KEY (student_profile_id) REFERENCES profiles(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."grading_conflicts" validate constraint "grading_conflicts_student_profile_id_fkey";

alter table "public"."grading_conflicts" add constraint "unique_grading_conflict_key" UNIQUE using index "unique_grading_conflict_key";

alter table "public"."review_assignment_rubric_parts" add constraint "review_assignment_rubric_parts_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignment_rubric_parts" validate constraint "review_assignment_rubric_parts_class_id_fkey";

alter table "public"."review_assignment_rubric_parts" add constraint "review_assignment_rubric_parts_review_assignment_id_fkey" FOREIGN KEY (review_assignment_id) REFERENCES review_assignments(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignment_rubric_parts" validate constraint "review_assignment_rubric_parts_review_assignment_id_fkey";

alter table "public"."review_assignment_rubric_parts" add constraint "review_assignment_rubric_parts_rubric_part_id_fkey" FOREIGN KEY (rubric_part_id) REFERENCES rubric_parts(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignment_rubric_parts" validate constraint "review_assignment_rubric_parts_rubric_part_id_fkey";

alter table "public"."review_assignment_rubric_parts" add constraint "unique_review_assignment_rubric_part" UNIQUE using index "unique_review_assignment_rubric_part";

alter table "public"."review_assignments" add constraint "review_assignments_assignee_profile_id_fkey" FOREIGN KEY (assignee_profile_id) REFERENCES profiles(id) ON UPDATE CASCADE ON DELETE RESTRICT not valid;

alter table "public"."review_assignments" validate constraint "review_assignments_assignee_profile_id_fkey";

alter table "public"."review_assignments" add constraint "review_assignments_assignment_id_fkey" FOREIGN KEY (assignment_id) REFERENCES assignments(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignments" validate constraint "review_assignments_assignment_id_fkey";

alter table "public"."review_assignments" add constraint "review_assignments_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignments" validate constraint "review_assignments_class_id_fkey";

alter table "public"."review_assignments" add constraint "review_assignments_rubric_id_fkey" FOREIGN KEY (rubric_id) REFERENCES rubrics(id) ON UPDATE CASCADE ON DELETE RESTRICT not valid;

alter table "public"."review_assignments" validate constraint "review_assignments_rubric_id_fkey";

alter table "public"."review_assignments" add constraint "review_assignments_submission_id_fkey" FOREIGN KEY (submission_id) REFERENCES submissions(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."review_assignments" validate constraint "review_assignments_submission_id_fkey";

alter table "public"."rubric_check_references" add constraint "rubric_check_references_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."rubric_check_references" validate constraint "rubric_check_references_class_id_fkey";

alter table "public"."rubric_check_references" add constraint "rubric_check_references_referenced_rubric_check_id_fkey" FOREIGN KEY (referenced_rubric_check_id) REFERENCES rubric_checks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."rubric_check_references" validate constraint "rubric_check_references_referenced_rubric_check_id_fkey";

alter table "public"."rubric_check_references" add constraint "rubric_check_references_referencing_rubric_check_id_fkey" FOREIGN KEY (referencing_rubric_check_id) REFERENCES rubric_checks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."rubric_check_references" validate constraint "rubric_check_references_referencing_rubric_check_id_fkey";

alter table "public"."rubric_check_references" add constraint "unique_rubric_check_reference_per_class" UNIQUE using index "unique_rubric_check_reference_per_class";

grant delete on table "public"."grading_conflicts" to "anon";

grant insert on table "public"."grading_conflicts" to "anon";

grant references on table "public"."grading_conflicts" to "anon";

grant select on table "public"."grading_conflicts" to "anon";

grant trigger on table "public"."grading_conflicts" to "anon";

grant truncate on table "public"."grading_conflicts" to "anon";

grant update on table "public"."grading_conflicts" to "anon";

grant delete on table "public"."grading_conflicts" to "authenticated";

grant insert on table "public"."grading_conflicts" to "authenticated";

grant references on table "public"."grading_conflicts" to "authenticated";

grant select on table "public"."grading_conflicts" to "authenticated";

grant trigger on table "public"."grading_conflicts" to "authenticated";

grant truncate on table "public"."grading_conflicts" to "authenticated";

grant update on table "public"."grading_conflicts" to "authenticated";

grant delete on table "public"."grading_conflicts" to "service_role";

grant insert on table "public"."grading_conflicts" to "service_role";

grant references on table "public"."grading_conflicts" to "service_role";

grant select on table "public"."grading_conflicts" to "service_role";

grant trigger on table "public"."grading_conflicts" to "service_role";

grant truncate on table "public"."grading_conflicts" to "service_role";

grant update on table "public"."grading_conflicts" to "service_role";

grant delete on table "public"."review_assignment_rubric_parts" to "anon";

grant insert on table "public"."review_assignment_rubric_parts" to "anon";

grant references on table "public"."review_assignment_rubric_parts" to "anon";

grant select on table "public"."review_assignment_rubric_parts" to "anon";

grant trigger on table "public"."review_assignment_rubric_parts" to "anon";

grant truncate on table "public"."review_assignment_rubric_parts" to "anon";

grant update on table "public"."review_assignment_rubric_parts" to "anon";

grant delete on table "public"."review_assignment_rubric_parts" to "authenticated";

grant insert on table "public"."review_assignment_rubric_parts" to "authenticated";

grant references on table "public"."review_assignment_rubric_parts" to "authenticated";

grant select on table "public"."review_assignment_rubric_parts" to "authenticated";

grant trigger on table "public"."review_assignment_rubric_parts" to "authenticated";

grant truncate on table "public"."review_assignment_rubric_parts" to "authenticated";

grant update on table "public"."review_assignment_rubric_parts" to "authenticated";

grant delete on table "public"."review_assignment_rubric_parts" to "service_role";

grant insert on table "public"."review_assignment_rubric_parts" to "service_role";

grant references on table "public"."review_assignment_rubric_parts" to "service_role";

grant select on table "public"."review_assignment_rubric_parts" to "service_role";

grant trigger on table "public"."review_assignment_rubric_parts" to "service_role";

grant truncate on table "public"."review_assignment_rubric_parts" to "service_role";

grant update on table "public"."review_assignment_rubric_parts" to "service_role";

grant delete on table "public"."review_assignments" to "anon";

grant insert on table "public"."review_assignments" to "anon";

grant references on table "public"."review_assignments" to "anon";

grant select on table "public"."review_assignments" to "anon";

grant trigger on table "public"."review_assignments" to "anon";

grant truncate on table "public"."review_assignments" to "anon";

grant update on table "public"."review_assignments" to "anon";

grant delete on table "public"."review_assignments" to "authenticated";

grant insert on table "public"."review_assignments" to "authenticated";

grant references on table "public"."review_assignments" to "authenticated";

grant select on table "public"."review_assignments" to "authenticated";

grant trigger on table "public"."review_assignments" to "authenticated";

grant truncate on table "public"."review_assignments" to "authenticated";

grant update on table "public"."review_assignments" to "authenticated";

grant delete on table "public"."review_assignments" to "service_role";

grant insert on table "public"."review_assignments" to "service_role";

grant references on table "public"."review_assignments" to "service_role";

grant select on table "public"."review_assignments" to "service_role";

grant trigger on table "public"."review_assignments" to "service_role";

grant truncate on table "public"."review_assignments" to "service_role";

grant update on table "public"."review_assignments" to "service_role";

grant delete on table "public"."rubric_check_references" to "anon";

grant insert on table "public"."rubric_check_references" to "anon";

grant references on table "public"."rubric_check_references" to "anon";

grant select on table "public"."rubric_check_references" to "anon";

grant trigger on table "public"."rubric_check_references" to "anon";

grant truncate on table "public"."rubric_check_references" to "anon";

grant update on table "public"."rubric_check_references" to "anon";

grant delete on table "public"."rubric_check_references" to "authenticated";

grant insert on table "public"."rubric_check_references" to "authenticated";

grant references on table "public"."rubric_check_references" to "authenticated";

grant select on table "public"."rubric_check_references" to "authenticated";

grant trigger on table "public"."rubric_check_references" to "authenticated";

grant truncate on table "public"."rubric_check_references" to "authenticated";

grant update on table "public"."rubric_check_references" to "authenticated";

grant delete on table "public"."rubric_check_references" to "service_role";

grant insert on table "public"."rubric_check_references" to "service_role";

grant references on table "public"."rubric_check_references" to "service_role";

grant select on table "public"."rubric_check_references" to "service_role";

grant trigger on table "public"."rubric_check_references" to "service_role";

grant truncate on table "public"."rubric_check_references" to "service_role";

grant update on table "public"."rubric_check_references" to "service_role";


