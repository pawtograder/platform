create table "public"."submission_artifact_comments" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "submission_id" bigint not null,
    "author" uuid not null,
    "comment" text not null,
    "points" integer,
    "class_id" bigint not null,
    "released" boolean not null default false,
    "rubric_check_id" bigint,
    "edited_by" uuid,
    "edited_at" timestamp with time zone,
    "deleted_at" timestamp with time zone,
    "submission_review_id" bigint,
    "submission_artifact_id" bigint not null
);


alter table "public"."submission_artifact_comments" enable row level security;

create table "public"."submission_artifacts" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "name" text not null,
    "submission_id" bigint not null,
    "submission_file_id" bigint,
    "class_id" bigint not null,
    "profile_id" uuid,
    "assignment_group_id" bigint,
    "data" jsonb
);


alter table "public"."submission_artifacts" enable row level security;

alter table "public"."repositories" add column "synced_handout_sha" text;

alter table "public"."rubric_checks" add column "artifact" text;

CREATE UNIQUE INDEX submission_artifact_comments_pkey ON public.submission_artifact_comments USING btree (id);

CREATE UNIQUE INDEX submission_artifacts_pkey ON public.submission_artifacts USING btree (id);

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_pkey" PRIMARY KEY using index "submission_artifact_comments_pkey";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_pkey" PRIMARY KEY using index "submission_artifacts_pkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_author_fkey" FOREIGN KEY (author) REFERENCES profiles(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_author_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_author_fkey1" FOREIGN KEY (author) REFERENCES profiles(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_author_fkey1";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_class_id_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_class_id_fkey1" FOREIGN KEY (class_id) REFERENCES classes(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_class_id_fkey1";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_rubric_check_id_fkey" FOREIGN KEY (rubric_check_id) REFERENCES rubric_checks(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_rubric_check_id_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_rubric_check_id_fkey1" FOREIGN KEY (rubric_check_id) REFERENCES rubric_checks(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_rubric_check_id_fkey1";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_submission_artifact_id_fkey" FOREIGN KEY (submission_artifact_id) REFERENCES submission_artifacts(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_submission_artifact_id_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_submission_id_fkey" FOREIGN KEY (submission_id) REFERENCES submissions(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_submission_id_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_submission_id_fkey1" FOREIGN KEY (submission_id) REFERENCES submissions(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_submission_id_fkey1";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_submission_review_id_fkey" FOREIGN KEY (submission_review_id) REFERENCES submission_reviews(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_submission_review_id_fkey";

alter table "public"."submission_artifact_comments" add constraint "submission_artifact_comments_submission_review_id_fkey1" FOREIGN KEY (submission_review_id) REFERENCES submission_reviews(id) not valid;

alter table "public"."submission_artifact_comments" validate constraint "submission_artifact_comments_submission_review_id_fkey1";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_assignment_group_id_fkey" FOREIGN KEY (assignment_group_id) REFERENCES assignment_groups(id) not valid;

alter table "public"."submission_artifacts" validate constraint "submission_artifacts_assignment_group_id_fkey";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_class_id_fkey" FOREIGN KEY (class_id) REFERENCES classes(id) not valid;

alter table "public"."submission_artifacts" validate constraint "submission_artifacts_class_id_fkey";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_profile_id_fkey" FOREIGN KEY (profile_id) REFERENCES profiles(id) not valid;

alter table "public"."submission_artifacts" validate constraint "submission_artifacts_profile_id_fkey";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_submission_file_id_fkey" FOREIGN KEY (submission_file_id) REFERENCES submission_files(id) not valid;

alter table "public"."submission_artifacts" validate constraint "submission_artifacts_submission_file_id_fkey";

alter table "public"."submission_artifacts" add constraint "submission_artifacts_submission_id_fkey" FOREIGN KEY (submission_id) REFERENCES submissions(id) not valid;

alter table "public"."submission_artifacts" validate constraint "submission_artifacts_submission_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.classes_populate_default_structures()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
    insert into discussion_topics (class_id, topic,color, description, ordinal)
       VALUES (NEW.id, 'Assignments', 'red', 'Questions and notes about assignments.', 1),
       (NEW.id, 'Logistics', 'orange', 'Anything else about the class', 2),
       (NEW.id, 'Readings', 'blue', 'Follow-ups and discussion of assigned and optional readings', 3),
       (NEW.id, 'Memes', 'purple', '#random', 4);
    insert into help_queues (name, description, class_id, available, depth)
       VALUES ('office-hours','This queue is staffed by TAs', NEW.id, TRUE, 0);   
   RETURN NEW;
end$function$
;

grant delete on table "public"."submission_artifact_comments" to "anon";

grant insert on table "public"."submission_artifact_comments" to "anon";

grant references on table "public"."submission_artifact_comments" to "anon";

grant select on table "public"."submission_artifact_comments" to "anon";

grant trigger on table "public"."submission_artifact_comments" to "anon";

grant truncate on table "public"."submission_artifact_comments" to "anon";

grant update on table "public"."submission_artifact_comments" to "anon";

grant delete on table "public"."submission_artifact_comments" to "authenticated";

grant insert on table "public"."submission_artifact_comments" to "authenticated";

grant references on table "public"."submission_artifact_comments" to "authenticated";

grant select on table "public"."submission_artifact_comments" to "authenticated";

grant trigger on table "public"."submission_artifact_comments" to "authenticated";

grant truncate on table "public"."submission_artifact_comments" to "authenticated";

grant update on table "public"."submission_artifact_comments" to "authenticated";

grant delete on table "public"."submission_artifact_comments" to "service_role";

grant insert on table "public"."submission_artifact_comments" to "service_role";

grant references on table "public"."submission_artifact_comments" to "service_role";

grant select on table "public"."submission_artifact_comments" to "service_role";

grant trigger on table "public"."submission_artifact_comments" to "service_role";

grant truncate on table "public"."submission_artifact_comments" to "service_role";

grant update on table "public"."submission_artifact_comments" to "service_role";

grant delete on table "public"."submission_artifacts" to "anon";

grant insert on table "public"."submission_artifacts" to "anon";

grant references on table "public"."submission_artifacts" to "anon";

grant select on table "public"."submission_artifacts" to "anon";

grant trigger on table "public"."submission_artifacts" to "anon";

grant truncate on table "public"."submission_artifacts" to "anon";

grant update on table "public"."submission_artifacts" to "anon";

grant delete on table "public"."submission_artifacts" to "authenticated";

grant insert on table "public"."submission_artifacts" to "authenticated";

grant references on table "public"."submission_artifacts" to "authenticated";

grant select on table "public"."submission_artifacts" to "authenticated";

grant trigger on table "public"."submission_artifacts" to "authenticated";

grant truncate on table "public"."submission_artifacts" to "authenticated";

grant update on table "public"."submission_artifacts" to "authenticated";

grant delete on table "public"."submission_artifacts" to "service_role";

grant insert on table "public"."submission_artifacts" to "service_role";

grant references on table "public"."submission_artifacts" to "service_role";

grant select on table "public"."submission_artifacts" to "service_role";

grant trigger on table "public"."submission_artifacts" to "service_role";

grant truncate on table "public"."submission_artifacts" to "service_role";

grant update on table "public"."submission_artifacts" to "service_role";

create policy "instructors, graders view all in class, students view own"
on "public"."submission_artifacts"
as permissive
for select
to public
using ((authorizeforclassgrader(class_id) OR authorizeforprofile(profile_id) OR authorizeforassignmentgroup(assignment_group_id)));


CREATE TRIGGER classes_insert_create_default_structure AFTER INSERT ON public.classes FOR EACH ROW EXECUTE FUNCTION classes_populate_default_structures();


