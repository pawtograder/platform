CREATE TABLE "public"."self_review_settings" (
    "id" bigint generated by default as identity not null,
    "enabled" boolean not null default false,
    "deadline_offset" bigint,
    "allow_early" boolean,
    "class_id" bigint not null
);

ALTER TABLE "public"."self_review_settings" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "instructors and graders can view self review settings" 
ON "public"."self_review_settings"
AS PERMISSIVE
FOR SELECT
USING (
    authorizeforclassinstructor(class_id) OR authorizeforclassgrader(class_id)
);

CREATE POLICY "instructors can insert self review settings" 
ON "public"."self_review_settings"
AS PERMISSIVE
FOR INSERT
WITH CHECK (
    authorizeforclassinstructor(class_id)
);

CREATE POLICY "instructors can delete self review settings" 
ON "public"."self_review_settings"
AS PERMISSIVE
FOR UPDATE
USING (
    authorizeforclassinstructor(class_id) 
);

CREATE POLICY "instructors can view delete review settings" 
ON "public"."self_review_settings"
AS PERMISSIVE
FOR DELETE
USING (
    authorizeforclassinstructor(class_id)
);

ALTER TABLE "public"."assignments" ADD COLUMN "self_review_setting_id" bigint;
