-- Create table for storing feedback on LLM hints from grader result tests
-- This allows students to provide feedback on the usefulness of AI-generated hints

create table "public"."grader_result_tests_hint_feedback" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "class_id" bigint not null,
    "grader_result_tests_id" bigint not null,
    "submission_id" bigint not null,
    "hint" text not null,
    "useful" boolean not null,
    "comment" text,
    "created_by" uuid not null
);

-- Enable RLS
alter table "public"."grader_result_tests_hint_feedback" enable row level security;

-- Add primary key constraint
alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_pkey" primary key ("id");

-- Add foreign key constraints
alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_class_id_fkey" foreign key ("class_id") references "public"."classes"("id") on delete cascade;

alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_grader_result_tests_id_fkey" foreign key ("grader_result_tests_id") references "public"."grader_result_tests"("id") on delete cascade;

alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_submission_id_fkey" foreign key ("submission_id") references "public"."submissions"("id") on delete cascade;

alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_created_by_fkey" foreign key ("created_by") references "public"."profiles"("id") on delete cascade;

-- Add indexes for performance
create index "idx_grader_result_tests_hint_feedback_class_id" on "public"."grader_result_tests_hint_feedback" using btree ("class_id");

create index "idx_grader_result_tests_hint_feedback_grader_result_tests_id" on "public"."grader_result_tests_hint_feedback" using btree ("grader_result_tests_id");

create index "idx_grader_result_tests_hint_feedback_submission_id" on "public"."grader_result_tests_hint_feedback" using btree ("submission_id");

create index "idx_grader_result_tests_hint_feedback_created_by" on "public"."grader_result_tests_hint_feedback" using btree ("created_by");

-- Add unique constraint to prevent duplicate feedback per user per test
alter table "public"."grader_result_tests_hint_feedback" add constraint "grader_result_tests_hint_feedback_unique_per_user_test" unique ("grader_result_tests_id", "created_by");

-- RLS Policies

-- Read policy: authorize_for_submission(submission_id)
create policy "Users can read feedback for submissions they have access to"
on "public"."grader_result_tests_hint_feedback"
for select
using (authorizeforclassgrader(class_id) OR authorize_for_submission(submission_id));

-- Insert policy: authorize_for_submission(submission_id) AND authorizeforprofile(created_by)
create policy "Users can insert feedback for submissions they have access to and own profile"
on "public"."grader_result_tests_hint_feedback"
for insert
with check (
    (authorize_for_submission(submission_id) OR authorizeforclassgrader(class_id))
    AND authorizeforprofile(created_by)
);

-- Update policy: authorize_for_submission(submission_id) AND authorizeforprofile(created_by)
create policy "Users can update their own feedback for submissions they have access to"
on "public"."grader_result_tests_hint_feedback"
for update
using (
    (authorize_for_submission(submission_id) OR authorizeforclassgrader(class_id))
    AND authorizeforprofile(created_by)
)
with check (
    (authorize_for_submission(submission_id) OR authorizeforclassgrader(class_id))
    AND authorizeforprofile(created_by)
);

-- Delete policy: authorize_for_submission(submission_id) AND authorizeforprofile(created_by)
create policy "Users can delete their own feedback for submissions they have access to"
on "public"."grader_result_tests_hint_feedback"
for delete
using (
    (authorize_for_submission(submission_id) OR authorizeforclassgrader(class_id))
    AND authorizeforprofile(created_by)
);

-- Add comments for documentation
comment on table "public"."grader_result_tests_hint_feedback" is 'Stores user feedback on AI-generated hints from grader result tests';
comment on column "public"."grader_result_tests_hint_feedback"."class_id" is 'Foreign key to classes table';
comment on column "public"."grader_result_tests_hint_feedback"."grader_result_tests_id" is 'Foreign key to grader_result_tests table';
comment on column "public"."grader_result_tests_hint_feedback"."submission_id" is 'Foreign key to submissions table';
comment on column "public"."grader_result_tests_hint_feedback"."hint" is 'The AI-generated hint text that was shown to the user';
comment on column "public"."grader_result_tests_hint_feedback"."useful" is 'Boolean indicating if the user found the hint useful';
comment on column "public"."grader_result_tests_hint_feedback"."comment" is 'Optional text comment from the user about the hint';
comment on column "public"."grader_result_tests_hint_feedback"."created_by" is 'Foreign key to profiles table - the user who provided the feedback';

-- Create table for tracking LLM inference usage statistics
create table "public"."llm_inference_usage" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "class_id" bigint not null,
    "created_by" uuid not null,
    "grader_result_test_id" bigint not null,
    "submission_id" bigint not null,
    "account" text not null,
    "model" text not null,
    "provider" text not null,
    "input_tokens" integer not null,
    "output_tokens" integer not null
);

-- Enable RLS
alter table "public"."llm_inference_usage" enable row level security;

-- Add primary key constraint
alter table "public"."llm_inference_usage" add constraint "llm_inference_usage_pkey" primary key ("id");

-- Add foreign key constraints
alter table "public"."llm_inference_usage" add constraint "llm_inference_usage_class_id_fkey" foreign key ("class_id") references "public"."classes"("id") on delete cascade;

alter table "public"."llm_inference_usage" add constraint "llm_inference_usage_created_by_fkey" foreign key ("created_by") references "auth"."users"("id") on delete cascade;

alter table "public"."llm_inference_usage" add constraint "llm_inference_usage_grader_result_test_id_fkey" foreign key ("grader_result_test_id") references "public"."grader_result_tests"("id") on delete cascade;

alter table "public"."llm_inference_usage" add constraint "llm_inference_usage_submission_id_fkey" foreign key ("submission_id") references "public"."submissions"("id") on delete cascade;

-- Add indexes for performance and analytics
create index "idx_llm_inference_usage_class_id" on "public"."llm_inference_usage" using btree ("class_id");

create index "idx_llm_inference_usage_created_by" on "public"."llm_inference_usage" using btree ("created_by");

create index "idx_llm_inference_usage_grader_result_test_id" on "public"."llm_inference_usage" using btree ("grader_result_test_id");

create index "idx_llm_inference_usage_submission_id" on "public"."llm_inference_usage" using btree ("submission_id");

create index "idx_llm_inference_usage_created_at" on "public"."llm_inference_usage" using btree ("created_at");

create index "idx_llm_inference_usage_account_provider" on "public"."llm_inference_usage" using btree ("account", "provider");

create index "idx_llm_inference_usage_model" on "public"."llm_inference_usage" using btree ("model");

-- RLS Policies for LLM inference usage

-- Read policy: Instructors and admins can read all usage data for their class
create policy "Instructors can read LLM usage data for their class"
on "public"."llm_inference_usage"
for select
using (
    authorizeforclassinstructor(class_id)
);

-- Insert policy: System can insert usage data (service role)
create policy "System can insert LLM usage data"
on "public"."llm_inference_usage"
for insert
with check (auth.role() = 'service_role');

-- No update/delete policies - this is append-only audit data

-- Add comments for documentation
comment on table "public"."llm_inference_usage" is 'Tracks LLM inference usage statistics for cost monitoring and analytics';
comment on column "public"."llm_inference_usage"."class_id" is 'Foreign key to classes table';
comment on column "public"."llm_inference_usage"."created_by" is 'Foreign key to auth.users table - the user who triggered the inference';
comment on column "public"."llm_inference_usage"."grader_result_test_id" is 'Foreign key to grader_result_tests table';
comment on column "public"."llm_inference_usage"."submission_id" is 'Foreign key to submissions table';
comment on column "public"."llm_inference_usage"."account" is 'LLM account/organization identifier used for billing';
comment on column "public"."llm_inference_usage"."model" is 'Model name/identifier used for the inference';
comment on column "public"."llm_inference_usage"."provider" is 'LLM provider (e.g., openai, anthropic, azure)';
comment on column "public"."llm_inference_usage"."input_tokens" is 'Number of input tokens consumed';
comment on column "public"."llm_inference_usage"."output_tokens" is 'Number of output tokens generated';
